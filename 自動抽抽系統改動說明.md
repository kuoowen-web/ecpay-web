# 自動抽抽系統改動說明

## 目錄

- [✅ 實作完成 - 功能總覽](#-實作完成---功能總覽)
- [🎯 新增內容](#-新增內容)
  - [1. 設定面板（底部）](#1-設定面板底部)
  - [2. 狀態監控](#2-狀態監控)
  - [3. 活動紀錄](#3-活動紀錄)
  - [4. 控制按鈕](#4-控制按鈕)
- [📖 使用方式](#-使用方式)
  - [測試模式（無需真實斗內）](#測試模式無需真實斗內)
  - [正式模式（連接真實斗內）](#正式模式連接真實斗內)
- [🔧 核心功能](#-核心功能)
- [🧪 測試清單](#-測試清單)
- [⚠️ 注意事項](#-注意事項)
- [🎨 UI 樣式](#-ui-樣式)
- [📊 系統運作流程](#-系統運作流程)

---

## ✅ 實作完成 - 功能總覽

所有主要功能均已完成並整合。

---

## 🎯 新增內容

### 1. 設定面板（底部）
位於頁面底部，包含：
- 商店代號：（寫你自己的 ID）
- 最低斗內金額：預設 100 TWD
- 必須包含訊息：預設「抽抽」（觸發關鍵字）
- 檢查間隔：預設 3 秒
- API Base URL：https://ecpay-web.onrender.com

### 2. 狀態監控
- 綠點（閃爍）：監控中
- 灰點：監控已停止
- 紅點：API 發生錯誤
- 顯示最後檢查時間與連線狀態

### 3. 活動紀錄
- 即時顯示所有操作紀錄
- 顏色區分：
  - 綠色：成功抽獎
  - 紅色：驗證失敗或錯誤
  - 藍色：資訊訊息
- 自動捲動顯示最新紀錄
- 僅保留最近 50 筆紀錄

### 4. 控制按鈕
1. ▶️ **開始監控** - 啟動自動監控
2. 🔍 **立即檢查斗內** - 手動強制檢查（未啟動時）
3. 🧪 **模擬新斗內** - 測試模式（模擬有效斗內）

---

## 📖 使用方式

### 測試模式（無需真實斗內）
1. 於瀏覽器中開啟檔案（應已開啟）
2. 設定獎項：
   - 調整獎項名稱
   - 設定中獎機率（總和需為 100%）
3. 點選「🧪 模擬新斗內」：
   - 模擬一筆有效斗內
   - 會自動觸發抽獎
   - 可於活動紀錄中查看結果

### 正式模式（連接真實斗內）
1. 設定參數：
   - 商店代號：（寫你自己的 ID）
   - 最低金額：100（可自行調整）
   - 關鍵字：「抽抽」（可自行調整）
   - 間隔時間：3 秒（API 輪詢頻率）
2. 點選「▶️ 開始監控」：
   - 設定欄位會鎖定
   - 狀態點變為綠色
   - 系統每 3 秒檢查一次 API
   - 第一次檢查僅記錄現有斗內，不觸發抽獎
   - 之後的檢查會偵測新斗內
3. 當有斗內時：
   - 檢查金額 ≥ 100 且訊息包含「抽抽」
   - 若符合條件 → 自動抽獎
   - 顯示通知並記錄中獎者
   - 更新獎項卡片動畫
4. 若要停止：點選「⏸️ 停止監控」

---

## 🔧 核心功能

### ✅ localStorage 資料保存
- 自動保存以下資訊：
  - 獎項設定
  - 抽獎狀態（哪些獎已抽出）
  - API 設定
  - 最近檢查紀錄
- 重新整理瀏覽器後仍會保留設定

### ✅ 智慧驗證
- 驗證斗內金額
- 驗證訊息關鍵字
- 詳細記錄驗證失敗原因
- 僅在兩者皆通過時觸發抽獎

### ✅ 錯誤處理
- 指數退避機制：API 失敗時重試（2s、4s、8s、16s、32s）
- 最多 5 次重試：超過即停止監控
- 錯誤提示：紅點 + 狀態欄錯誤訊息
- 可使用「立即檢查」手動重試

### ✅ 避免重複處理
- 記錄已處理的斗內
- 僅針對新斗內觸發抽獎
- 避免重新整理造成重複抽獎

---

## 🧪 測試清單

### 測試項目：
1. **localStorage 測試：**
   - 新增獎項後重新整理頁面
   - 獎項仍應存在 ✓
2. **模擬測試：**
   - 點選「🧪 模擬新斗內」
   - 觸發抽獎並在紀錄中顯示 ✓
3. **驗證測試：**
   - 將最低金額改為 200
   - 仍模擬 $100 斗內 → 驗證失敗 ✓
4. **監控啟停測試：**
   - 點選「▶️ 開始監控」 → 設定被鎖定
   - 點選「⏸️ 停止監控」 → 設定重新啟用 ✓
5. **手動抽獎測試：**
   - 點選右側「🎲 開始抽獎」
   - 與 API 抽獎功能獨立 ✓

---

## ⚠️ 注意事項

1. **首次監控檢查：** 啟動監控後會先記錄現有斗內，不觸發抽獎。
2. **機率驗證：** 啟動前會檢查總機率是否為 100%，否則顯示錯誤。
3. **獎項抽完：** 若所有獎項皆抽完，新斗內仍會記錄但不觸發抽獎，需手動點選「🔄 重置抽抽狀態」。
4. **API 錯誤：** 若無法連線，系統會依指數退避機制重試 5 次後停止。
5. **監控鎖定設定：** 監控進行中不可更改設定，需先停止。

---

## 🎨 UI 樣式

整體符合紫色漸層主題：
- 設定面板與右側面板背景一致
- 按鈕採用相同漸層風格
- 狀態點使用平滑閃爍動畫
- 活動紀錄以顏色區分條目

---

## 📊 系統運作流程

```
[用戶透過 ECPay 斗內]
        ↓
[ECPay API 更新]
        ↓
[系統每 3 秒輪詢]
        ↓
[偵測新斗內]
        ↓
[驗證金額 ≥ 100 且訊息包含「抽抽」]
        ↓
[若符合 → drawPrizeAuto()]
        ↓
[顯示通知 + 記錄中獎者]
        ↓
[更新 localStorage]
        ↓
[持續監控中...]
```

