{"version":3,"file":"index.494da9d103e1cdafc202.bundle.js","mappings":"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","sources":["webpack://common-vote/./app/index.js"],"sourcesContent":["// app/index.js\r\n// 使用一個標記來防止重複初始化\r\nlet isInitialized = false;\r\n\r\n// 在檔案最上方引入 CSS\r\nimport './css/common.css';\r\nimport './css/index.css';\r\n\r\nasync function initializeApp() {\r\n    if (isInitialized) {\r\n        console.log('Already initialized');\r\n        return;\r\n    }\r\n\r\n    isInitialized = true;\r\n    console.log('Initializing app...');\r\n\r\n    // 正確取得 merchantId\r\n    const urlParams = new URLSearchParams(window.location.search);\r\n    const merchantId = urlParams.get('id');\r\n\r\n    if (!merchantId) {\r\n        window.location.href = '/login.html';\r\n        return;\r\n    }\r\n\r\n    try {\r\n        // 確保使用正確的 URL 格式\r\n        const checkResponse = await fetch(\r\n            `/api/v1/comme/ecpay/check-merchant/id=${merchantId}`\r\n        );\r\n        const checkResult = await checkResponse.json();\r\n\r\n        if (!checkResponse.ok || !checkResult.exists) {\r\n            window.location.href = `/ecpay-setting.html?id=${merchantId}`;\r\n            return;\r\n        }\r\n\r\n        // 載入斗內資料\r\n        await loadDonations(merchantId);\r\n\r\n        // 設定定時更新（使用 let 以便可以清除）\r\n        let updateInterval = setInterval(\r\n            () => loadDonations(merchantId),\r\n            30000\r\n        );\r\n\r\n        // 在頁面離開時清除 interval\r\n        window.addEventListener('beforeunload', () => {\r\n            if (updateInterval) {\r\n                clearInterval(updateInterval);\r\n            }\r\n        });\r\n    } catch (error) {\r\n        console.error('初始化失敗:', error);\r\n    }\r\n}\r\n\r\n// 將載入捐款資料的邏輯抽出成獨立函數\r\nasync function loadDonations(merchantId) {\r\n    try {\r\n        console.log(`Loading donations for merchant ${merchantId}...`);\r\n        const response = await fetch(\r\n            `/api/v1/comme/ecpay/donations/id=${merchantId}`\r\n        );\r\n        const donations = await response.json();\r\n        updateDonationList(donations);\r\n    } catch (error) {\r\n        console.error('載入斗內資料失敗:', error);\r\n    }\r\n}\r\n\r\n// 更新畫面的函數\r\nfunction updateDonationList(donations) {\r\n    const donationList = document.getElementById('donationList');\r\n    const totalAmount = document.getElementById('totalAmount');\r\n\r\n    if (!donationList || !totalAmount) return;\r\n\r\n    let total = 0;\r\n    donationList.innerHTML = '';\r\n\r\n    // 依時間排序（最新的在前）\r\n    donations.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));\r\n\r\n    // 只顯示最新 5 筆（由下往上推）\r\n    const showCount = 5;\r\n    const showDonations = donations.slice(0, showCount).reverse(); // 取最新5筆，reverse讓最新在下方\r\n\r\n    showDonations.forEach(donation => {\r\n        const amount = parseInt(donation.cost) || 0;\r\n        total += amount;\r\n        const title = getSuperchatTitle(donation);\r\n        const tierClass = getSuperchatTierClass(donation.type, amount);\r\n        const message = donation.message || '';\r\n\r\n        // --- 改用 DOM API 動態建立卡片 ---\r\n        const card = document.createElement('div');\r\n        card.className = `superchat-card ${tierClass}`;\r\n\r\n        const content = document.createElement('div');\r\n        content.className = 'superchat-content';\r\n\r\n        const header = document.createElement('div');\r\n        header.className = 'superchat-header';\r\n\r\n        const nameSpan = document.createElement('span');\r\n        nameSpan.className = 'superchat-name';\r\n        nameSpan.textContent = donation.name || '匿名';\r\n\r\n        const amountSpan = document.createElement('span');\r\n        amountSpan.className = 'superchat-amount';\r\n        amountSpan.textContent = formatAmount(amount);\r\n\r\n        header.appendChild(nameSpan);\r\n        header.appendChild(amountSpan);\r\n\r\n        const titleDiv = document.createElement('div');\r\n        titleDiv.className = 'superchat-title';\r\n        titleDiv.textContent = title;\r\n\r\n        const messageDiv = document.createElement('div');\r\n        messageDiv.className = 'superchat-message';\r\n        messageDiv.textContent = message;\r\n\r\n        content.appendChild(header);\r\n        content.appendChild(titleDiv);\r\n        content.appendChild(messageDiv);\r\n        card.appendChild(content);\r\n        donationList.appendChild(card);\r\n    });\r\n\r\n    totalAmount.textContent = `總金額: ${formatAmount(total)}`;\r\n}\r\n\r\nfunction getSuperchatTitle(donation) {\r\n    // 依據 donation.type 給標題\r\n    if (donation.type === 'member') {\r\n        return '歡迎加入會員！';\r\n    } else if (donation.type === 'gift') {\r\n        return `贈送 ${donation.giftCount || ''} 份會員`;\r\n    } else if (donation.type === 'renew') {\r\n        return `會員 ${donation.months || 1} 個月`;\r\n    } else if (donation.type === 'superchat') {\r\n        return '';\r\n    }\r\n    return '';\r\n}\r\n\r\nfunction getSuperchatTierClass(type, amount) {\r\n    if (amount >= 750) return 'superchat-tier-red';\r\n    if (amount >= 300) return 'superchat-tier-orange';\r\n    if (amount >= 150) return 'superchat-tier-yellow';\r\n    if (amount >= 75) return 'superchat-tier-green';\r\n    if (amount >= 30) return 'superchat-tier-blue';\r\n    else return 'superchat-tier-blue';\r\n}\r\n\r\n// 格式化金額顯示\r\nfunction formatAmount(amount) {\r\n    return new Intl.NumberFormat('zh-TW', {\r\n        style: 'currency',\r\n        currency: 'TWD',\r\n    }).format(amount);\r\n}\r\n\r\n// 只有在 DOMContentLoaded 時初始化一次\r\ndocument.addEventListener('DOMContentLoaded', initializeApp, { once: true });\r\n\r\n// 如果有其他事件監聽器，確保它們也只註冊一次\r\nfunction initializeEventListeners() {\r\n    const settingsBtn = document.getElementById('settingsBtn');\r\n    if (settingsBtn) {\r\n        // 移除舊的事件監聽器（如果有的話）\r\n        settingsBtn.replaceWith(settingsBtn.cloneNode(true));\r\n        const newSettingsBtn = document.getElementById('settingsBtn');\r\n        newSettingsBtn.addEventListener('click', () => {\r\n            const merchantId = sessionStorage.getItem('merchantId');\r\n            if (merchantId) {\r\n                window.location.href = `/ecpay-setting.html?id=${merchantId}`;\r\n            }\r\n        });\r\n    }\r\n}\r\n"],"names":["isInitialized","async","loadDonations","merchantId","console","log","response","fetch","donations","donationList","document","getElementById","totalAmount","total","innerHTML","sort","a","b","Date","timestamp","slice","reverse","forEach","donation","amount","parseInt","cost","title","type","giftCount","months","getSuperchatTitle","tierClass","getSuperchatTierClass","message","card","createElement","className","content","header","nameSpan","textContent","name","amountSpan","formatAmount","appendChild","titleDiv","messageDiv","updateDonationList","json","error","Intl","NumberFormat","style","currency","format","addEventListener","URLSearchParams","window","location","search","get","checkResponse","checkResult","ok","exists","href","updateInterval","setInterval","clearInterval","once"],"sourceRoot":""}